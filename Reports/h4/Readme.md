# Porttiskannausta ja muuta tiedustelua

Tehtäväksi annettiin käydä lävitse useita nmap -ohjelman/komennon toimintoja, ja analysoida niitä. Tätä varten käytin aikaisemmille tehtäville pystyyn pistettyä metasploitable -maalikonetta, ja Kali Linux virtuaalikonetta itse skannausten ja pakettikaappausten tekemiseen Wiresharkin avulla.. Molemmat virtuaalikoneet olivat irroitettu julkisesta verkosta, ja niillä oli yhteys ainoastaan toisiinsa niiden paikallisessa virtualisoidusa verkossa.

### nmap TCP Connect Scan (-sT)
 
Aloitettiin ensin TCP Connect Scan:llä, eli nmap -komennolla -sT parametrin kanssa. [Nmap Reference Guide](https://nmap.org/book/scan-methods-connect-scan.html) kertoo tämän skannaustyypin olevan oletus-skannaustyyppi, jos SYN-skannausta ei voi käyttää koska käyttäjällä ei ole raakapakettien kirjoittamiseen oikeutta, tai käyttäjä skannaa IPv6 -verkkoja. Tämä skannaus siis yrittää luoda yhteyksiä useisiin portteihin sen sijaan, että se lähettäisi niihin raakoja paketteja. Reference guide varoittaa myös, että SYN-skannaus olisi parempi vaihtoehtona ei pelkästään sen takia, että se ei ole yhtä tehokas, vaan että siitä jää myös enemmän todistusaineistoia, koska Connect Scan vie yhteydenluonnin loppuun asti.

Ajoin Kali-koneella komennon ``sudo nmap -sT <metasploitable osoite>`` raakana samalla, kun Wireshark loggasi pakettien kulkua portista jolla oli yhteys virtuaaliverkkoon.

![image](https://user-images.githubusercontent.com/94109769/202847449-218e2a88-78bc-4b33-9b5a-d3b0fedb6419.png)

Tämä nmapin porttiskannauksen tulos oli jo aikaisemmasta harjoituksesta tuttu, mutta itselleni bongasi silmään rivi, jolla kerrottiin tulostuksesta jääneen pois 977 suljettua porttia. Avoimia portteja oli listattu 23, joten nopea matikka kertoi, että portteja olisi yhteensä skannattu 1000. Oletukseni tästä on, että tämä skannaustyyppi skannaa 1000 ennalta määriteltyä TCP-porttia, jotka oletettavasti ovat yleisimmin käytettyjä portteja palvelinympäristöillä.

Wireshark taas kaappasi todella suuren määrän liikennettä:

![image](https://user-images.githubusercontent.com/94109769/202847613-7277e16c-60b7-402a-9d0c-df7157683c44.png)

Rivejä oli päälle kaksi tuhatta, ja tätä oli oikein vaikea tulkita puhtaasti, koska nmap selvästi oli lähettänyt niin monelle portille yhtäaikaisesti paketteja, että vastauksiakaan ei ehtinyt tulemaan takaisin maalikoneesta heti. Nappasin alkupäästä ainakin yhden portin, jota ei selvästikkään ollut tullut nmapin tulosteeseen, ja filtteröin tulosteen sen perusteella, jotta voin tarkemmin tutkia, mitä sen kanssa oli käynyt.

![image](https://user-images.githubusercontent.com/94109769/202847694-33132be3-0bb6-48fb-916e-277e8d8fe63a.png)

Portille 256 oli lähetetty siis SYN paketti, jolla yritettiin luoda avointa yhteyttä kohteelle tämän portin kautta. Vastauksena maalikone olikin lähettänyt suoraan RST (eli RESET) paketin, joka katkaisi yhteyden suoraan. Tämä indikoi siis, että kohde ei hyväksy enempää liikennettä/dataa tästä portista, joten voimme päätellä, että portti todennäköisesti on kiinni.

Vastaavasti filtteröin seuraavaksi wiresharkin näyttämään kaapatut paketit portilta 111, joka oli päässyt nmapin tulosteeseen:

![image](https://user-images.githubusercontent.com/94109769/202847790-71ad6a68-5762-45d4-a1bc-9005bd21b44d.png)

Täällähän tapahtuikin enemmän. SYN -paketin vastaanotettuaan portilta 111, maalikone lähettekin takaisin SYN, ACK -paketin. Eli toisensanoan se hyväksyi vastaanotetun SYN -paketin, ja lähetti samanlaisen takaisin avatakseen molemminpuolisen yhteyden. Tämän paketin saatuaan Kali kone hyväksyi sen ensin, mutta sen jälkeen lähetti heti RST -paketin maalikoneelle katkaistakseen yhteyden. Eli lyhykäisyydessään voi sanoa, että tämä nmap skannaus yrittyi luoda yhteyksiä tuhannen eri portin kautta, ja kirjasi ylös ne portit, joilla yhteydenotto onnistui.

### nmap TCP SYN "Stealth" scan (-sS)

SYN -skannaus mainittiinkin jo nmap reference guidessa edellistä skannaustyyppiä tutkiessa. Tämän skannaustyypin olisi siis tarkoitus olla vaikeammin huomattava ja tehokkaampi Connect -skanniin verrattuna. Se vaatii myös raaka-pakettien oikeudet, joten tämä ei onnistuisi ilman sudotusta.

Kokeilin tätä heti komennolla ``sudo nmap -sS <metasploitable osoite>``. Nmapin tuloste oli täysin sama kuin -sT komennollakin. Wiresharkissa 256 portilla näkyi myös täsmälleen sama liikenne (SYN paketti portille 256, RST paketti samantien takaisin koska se oli kiinni), mutta portin 111 kohdalla näkyi eroa:

![image](https://user-images.githubusercontent.com/94109769/202848264-6ac6d869-5717-42ba-b73b-8fa3c24c632b.png)

Maalikone lähetti jälleen SYN, ACK -viestin takaisin Kali koneelle, mutta tällä kertaa Kali samantien lähetti RST viestin, estääkseen yhteyden loppuunmuodostamisen.

### Ping Sweep (-sn)

Nopea silmäily jälleen [nmap reference guidin puolella](https://nmap.org/book/man-host-discovery.html) kertoi -sn parametrin vain skannavaan vastaavia verkkolaitteita ilman porttiskannauksia. Tätä on hyvä hyödyntää pelkästään selvittämään kuinka monta muuta laitetta verkossa on.

Tässä tapauksessa käytin komentoa ``sudo nmap -sn <skannattava verkkoavaruus>``. Sen sijaan, että olisin nyt antanut suoraan metasplotablen ip-osoitteen, lähden skenaariolla liikkelle, jossa vielä ei tiedetä mitä muita koneita verkosta löytyy. Eli tämän sijaan käytinkin verkkotunnistetta ``192.162.60.0/24``, joka käytännössä tulee määrittelemään, että nmap tekee host-discoveryn ip-osoittellee haarukalla 192.162.60.0 - 192.162.60.255.

![image](https://user-images.githubusercontent.com/94109769/202848698-2f8e6d21-7dbf-433a-90d9-acb88574fc62.png)

Jos verkolle olisi määritelty nimipalvelin, oltaisiin tällä koneella saatu Reverse-DNS kyselyllä selville myös koneiden nimeet. Tässä tapauksessa meille riittää nyt kuitenkin nämä tiedot. .1 päättyinen ip osoite on todennäköisimmin verkon gateway, .3 on oma osoite, ja .4 on maalikone. En ole ihan varma mikä .2 tässä on, mutta koska sen MAC osoite vastaa Virtualboxin virtuaalista verkkoadapteria, ehkä se on jokin ylijäämä virtuaaliverkossa?

![image](https://user-images.githubusercontent.com/94109769/202848853-43cc32e9-76b2-4863-be67-e453c4c716cf.png)

Wiresharkista nähdään, mitä nmap käytännössä siis teki. Se lähetti ARP kyselyviestejä järjestyksessjä jokaisesta mahdollisesta osoitteesta määritellystä verkkoavaruudesta. Ja koska ARP-viestit ovat broadcast-viestejä, kaikki muut laitteet havaitsevat sen vaikkei niitä ole määritelty erikseen vastaanottajaksi. Nmap kirjasi ylös siis ne ip-osoitteet, joista saatiin vastaus.

### Don't Ping (-Pn)

Reference Guide:n sama sivu kertoi -Pn parametrista sen, että sitä käytetään host discovery:n ohittamiseen, ja tällä parametrilla nmap tekee porttiskannaukset jokaiselle laitteelle verkossa joka tapauksessa sillä oletuksella, että ne olisivat ylhäällä. Nopea testaus ja reference guide:n oma huomautuskin tosin paljasti, että ARP-kysely tehdään paikallisella verkolla joka tapauksessa, koska nmap tarvitsee vastaanottavien porttien MAC-osoitteet. Tämä todennäköisesti olisi tarkoitus ohittaa ICMP-viestien lähettäminen kokonaan, mutta en wiresharkin tulosteissa ollut nähnyt ICMP-viestejä aikaisemmissakaan komennoissa, joten itselleni jäi kuitenkin mysteeriksi, mikä tämän käyttötarkoitus olisi. Ehkä ping-viestien lähettämisen ohitus ulkoisia verkkoja skannatessa? En ihan kehdannut sitä kuitenkaan labrata, koska itseltäni ei löytynyt ympäristöä joka sallisi sen laillisissa puitteissa.

### Version detection (-sV)

-sV parametrilla otetaan käyttöön nmapilla versionhavainnointi. Normaalissa nmapin tulosteessa nmap osaa jo kertoa suurinpiirtein [nmap reference guide:n](https://nmap.org/book/man-version-detection.html) mukaan perustuen tietokantaan jota se referoi, mihin näitä avoimia portteja todennäköisimmin käytetään. Esimerkiksi portti 22 merkataan ssh -protokollan alle, koska se on oletusportti SSH-yhteyksille. Pelkästään näillä tiedoilla ei tietenkään saa selville mitä ohjelmistoja portin takana todennäköisesti pyörii. Parametrin -sV kanssa nmap alkaa pommittamaan avoimia portteja porttiskannauksen jälkeen paketeilla ja kyselyillä, joilla se hakee vielä suurempaan tietokantaan perustuen tietoja, koittaen sovittaa kohteelta saamia vastauksia tietokanansta löytyviin tietoihin ja tätne lopulta päättelemään ohjelmiston ja sen version, joka portin takana on.

Testatin tätä ajamalla komennon ``sudo nmap -sV <metasploitablen IP>`` ja tarkistelemalla Wiresharkin kaappaamia paketteja filtteröitynä paketteihin, jotka ovat kulkeneet portin 8180 kautta. Metasploitablella porttin 8180 takana tunnistettiin pyörivän Apache Tomcat/Coyote JSP engine 1.1 palvelin, joten halusin koittaa tarkistella, mitä liikennettä portin lävitse on kulkenut jonka perusteella nmap oli tullut tähän johtopäätökseen. 

![image](https://user-images.githubusercontent.com/94109769/202866547-4a15b1ad-c1d3-4f45-a429-f8350200c57a.png)

Paketteja oli kymmenittäin. Sen verran, ettei niitä tässä tapauksessa saada millään järkevästi näkymään kuvakaappauksissa siististi. Pakettien silmäily ei sinänsä valottanut asiaa itsellenikään kauhean paljon. Liikenteestä löytyy paljon toistettuja yhteyden avauksia ja sulkuja ilman erityisempää liikennettä niiden välissä, eikä näiden pakettien tarkempi tutkiminen tuonut ainakaan itselleni mitään ymmärrystä, koska niistä ei löydy oikeastaan mitään selkotekstinä. Ainoa arvaukseni on, että nmap oli kokeillut, millaisilla vastauspaketeilla portti reagoi tiettyihin koodinpätkiin tai vastaavaa?

Muutaman yhteysyrityksen jälkeen nmap oli alkanut lähettämään erilaisia HTTP paketteja.

![image](https://user-images.githubusercontent.com/94109769/202866668-37662fcb-67ee-4403-8a10-19eb73a8d341.png)

Tämä esimerkkinä yhdestä paketista, jota nmap oli lähettänyt. En ymmärrä http-protokollankaan toimintaa niin syvällisesti, että kunnolla ymmärtäisin mitä se tarkalleen ottaen oli tällä GET -pyynnöllä koittanut saada, tai miten tämän odotettiin reagoivan. Pakettien määrästä ja erilaisuudesta jopa pelkästään HTTP-pakettien sisällä voinen tosin olettaa, että jotain järjestelmällistä testausta kaiken taustalla kuitenkin tapahtui.

### Porttivalinta

Nmapille voi myös määritellä täsmälleen mitä portteja se skannaa. Parametrilla -p<x>-<y> se skannaa portit tietyllä haarukkavälillä. Esimerkiksi -p1-100 skannaisi portit ykkösestä sataan. Parametrilla --top-ports taas testauksen perusteella skannaa järjestyksessä kaikkein yleisiimmät portit; esimerkiksi --top-ports 5 parametrilla se skannaa viisi yleisintä porttia (jotka muuten ovat 21, 22, 23, 80 ja 443). Mahdollisuutena on myös parametri -p-, jota testasin myös itse. Nmapin tulostus ilmoitti löytäneensä avoimien portiten lisäksi 65505 suljettua porttia, sekä muutaman avoimen portin jota perusskannilla ei löytynyt, eli ilmeisimmin tämä skannaa **kaikki** mahdolliset portit, eikä pelkästään 10000 yleistä tunnettua porttia.

### Osoitevalinta

Osoitteitakin voi määritellä kohteeksi usealla tavalla. AIkaisemmin olin käyttänyt pelkästään perus yhtä IP-osoitetta, mutta yksittäisiä ip-osoitteita voi listata pelkästään välimerkkiä käyttämällä erottajana. Olin jo käyttänyt myös verkkoavaruuden määritelmää formaatilla x.x.x.x/x, jossa kauttaviivan jälkeinen merkki määrittelee verkkomaskin suuruuden biteillä. Tähän kannattaa käyttää jotain aputyökalua jos meinaa skannatta osoitavaruuksia muiden kuin kahdeksalla jaollisten maskien kanssa, sillä ne eivät enää jaa osoitteita siististi oktettien mukaan.
  
Lisäksi löytyy myös manuaalisesti määriteltävä haarukka yhden aliverkon alla, esimerkiksi 192.169.0.1-25.

### Output files
  
### Ajonaikaiset toiminnot

### Nmap sudolla ja ilman sudoa

Testasin tässä, miten puhdas nmap komennon ajo eroaa ilman sudotusta, ja sudotuksen kanssa. Testaamalla ensin ilman sudotusta, wireshark näytti samanlaisen liikenteen tuloksen kuin ensimmäinen TCP Connect skannaus jota tein alussa -- eli se loi yhteyksenaloituksen maalikoneen kanssa, maalikone lähetti takaisin ACK paketin ja oman SYN paketin molemminpuolisen yhteyden aloittamiseen, oma kone lähetti tästä ACK paketin ja sen jälkeen RST paketin yhteyden sulkemiseen. Sudotuksen kanssa wiresharkista näkyi sama tulos kuin aikaisemmalla SYN -skannilla. Eli avoin portti lähetti taaskin SYN, ACK -paketin, mutta sen sijaan että oma kone olisi vastannut sille ACK paketilla, se saman tien lähetti RST paketin ennen kuin yhteys tuli avattua loppuun.
  
Eli toisin sanoen nmap ajaa ilman sudoa oletus-skannina TCP Connect skannin, eli saman kuin käyttäisi parametria -sT, ja sudolla SYN skannin, eli saman kuin käyttäisi parametria -sS.
  
### -A
  
Tehtävänä annettiin myös testata nmap komentoa -A -parametrilla, ja testata sen eroavaisuutta ajaa ilman sitä. Testasin tätä taas metasploitableen, ja huomasin heti, että sillä kesti hirveästi pidempään kuin ilman (ilman meni alle sekunti, -A:n kannsa joutui odottamaan ehkä 15s). Huomasin samalla Wiresharkista, että siellä liikkui vanka kuinka paljoin erinäisten protokollien paketteja; epäilykseni olisi että se heitti samoja paketteja mitä se käyttäisi version-havaoinnoinnissakin.
  
Kalin komentorivillä tuloste oli myös aika verboosi:
  
![image](https://user-images.githubusercontent.com/94109769/202867755-bd74992c-556b-4cbe-bf74-ecb3ab6c6df7.png)

Tämä osasi siis kertoa palvelun/ohjelman version ja mallin lisäksi useita yksityiskohtaisia tietoja-- jopa smtp -palvelun käyttämää sertifikaattia ja kuinka kauan se on voimassa! Yritin etsiä netistä tietoa siitä, mitä -A parametri oikeasti tekee, mutta en löytänyt jostain syystä suoraa vastausta pelkästään googlettamalla. Tämän datan määrän perusteella tosin arvaisin, että tämä parametri sai nmapin ajaamaan kaikki mahdolliset havainnointitoiminnot, mitä siltä löytyy.
  

  
## Lähteet

[Kurssisivun tehtävänanto](https://terokarvinen.com/2022/tunkeutumistestaus-ict4tn027-3010-syksylla-2022/#h4-intelligence-cap)
[Nmap Reference Guide](https://nmap.org/book/toc.html)
