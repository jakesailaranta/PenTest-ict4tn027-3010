# Metasploitable 2 harjotusta

Viikon 2 aiheena tunkattiin alustavia harjoitusympäristöjä kasaan, hyödyntäen Virtualboxia ja Metasploitable 2:sta.

## X)

Alustavana tehtävänä oli lukea ja tiivistää [Mastering Metasploit](https://learning.oreilly.com/library/view/mastering-metasploit-/9781838980078/B15076_01_Final_ASB_ePub.xhtml#_idParaDest-30) -kirjan ensimmäinen kappale, joka käsittelee Metasploit -ohjelmistan perusteita ja sen hyödyntämistä tunkeutumistestauksessa.

- Metasploit on ohjelmisto/käyttöympäristö, josta löytyy useita työkaluja tiedon keräämiseen paikallisverkossa sekä monia sisäänrakennettuja exploit-skriptejä joita voi hyödyntää tunkeutumistestauksessa.
- Metasploit hyödyntää myös integroitua tietokantaa, johon helposti listataan haettavaksi tietoja lähiverkon skannauksia kerättyjä tietoja
- Virallista tunkeutumistestausta suorittaesa pitäisi varmistaa, että suunnitelmat ja organisoinnit ovat rakennettu ]tunkeutumistestauksen standardeja](http://www.pentest-standard.org/index.php/PTES_Technical_Guidelines) noudattaen, sekä määritellä asiakkaan/kohteen kanssa säännöt, joiden mukaan tunkeutumistestaaja tulee toimimaan (esim, millaisia hyökkäyksiä on sallittu, mihin osiin organisaatiota tunkeutumistestaus kohdistuu)

Suurin osa teoria-asioiden jälkeen kappaleessa käy lävitse esimerkkitapausta Metasploitin kanssa harjoittelemiseen, jota hyödynnettiin muiden viikon tehtävien ratkaisemisessa. Mutta muutamia hyödyllisiä Metasploit-komentoja jota alustavasti listattiin:

- ``msfconsole``: Käynnistää metasploitin konsolin
- ``msfdb run``: Käynnistää Metasploitin tietokannan. Jos metasploit-konsolie ei ole jo auki tätä ajeassa, se käynnistää myös konsolin samalla.
- ``show [Auxiliary/Exploit/Payload/Encoder/evasion]``: Listaa eri moduulityyppejä. Esimerkkinä Exploit -kategorian moduulit hyödyntävät koodia, jolla käytetään hyöydyksi kohdekoneen haavoittuvuutta. Metasploitissa tulee valmiiksi useita exploit-moduuleja, jotka on rakennettu tunnettujen haavoittuvaisten ohjelmien kohdalle.
- ``use [module]``: Ottaa määritellyn moduulin käyttöön (esimerkkinä ``use exploit/windows/vnc/ultravnc_client``).
- ``set [options/payload]``: Aseta parametreja moduuleille, esim ``set RHOST <osoite>`` useilla moduuleilla asettaa kohdekoneen IP-osoitteen. ``set payload <payload>`` määrittelee myös payload-paketin, eli koodin jota ajetaan kun exploit-moduuli on ajettu kohteelle onnistuneesti (huom: ``show payloads``)
- ``setg [options]``: Määrittelee asetuksia globaalisti, jotta ei tarvitsisi esimerkiksi kirjoittaa RHOST parametria jokaiseen paikkaan uusiksi moduuleita vaihdettaessa, jos kohdekone on aina sama. 
- ``info <moduuli>``: Näyttää tietoja määritellystä moduulista
- ``search <hakutermi>``: Hakee moduulia hakutermin mukaan
- ``check``: Tarkistaa, onko kohdekone altis valitulle epxloit-moduulille. Monet moduulit eivät tosin tätä tarkistusta tue.

## A) Metasploitable 2 asennus

Metasploit 2 -harjoitusmaalikoneen asensinkin jo luennon aikana, joten tämä osa raportista pohjautuu ulkomuistiin.

Metasploit 2:n tiedostot sain ladattua sivulta [https://sourceforge.net/projects/metasploitable/files/latest/download](https://sourceforge.net/projects/metasploitable/files/latest/download). .zip-arkiston purkamisen jälkeen menin luomaan uuden VM-koneen Virtualboxissa. Tiedosto, jonka latasin ei ollutkaan asennuslevyke tai kuvanne, vaan virtuaalinen kovalevy, joten minun piti tässä vaiheessa liittää se koneeseen. Tämä tapahtui valitsemalla Metasploitable -kone Virtualboxin listasta, ja kulkemalla valikkoihin Settings > Storage ja tässä ikkunassa painamalla seuraavaa nappia:

![image](https://user-images.githubusercontent.com/94109769/200134366-bf667305-8b6c-469d-a380-00d4fb3bda57.png)

Kuvakaappauksessa nappi on harmaana, koska kovalevy on jo liitetty siihen. Mutta valitsemalla tähän tiedoston MEtasploitable.vmdk, virtuaalinen kovalevy mountattiin VM:ään. 

Tässä vaiheessa en vielä käynnistänyt kuitenkaan tietokonetta, koska se ei ole vielä omassa verkossaan. .Tässä vaiheessa piti luoda testiympäristölle oma virtuaaliverkko. Valikosta Tools > Host NEtwork Manager saatiin virtuaaliverkon hallinnan ikkuna auki.

![image](https://user-images.githubusercontent.com/94109769/200134445-087a8120-62e1-4b12-aaf4-130c047a39ba.png)

Create napilla luotiin uusi Host-Only Ethernet Adapter:n alle menevä verkko. Tämän verkon avulla VM:t voivat keskustella keskenään verkossa, mutta sillä ei saa internettiin yhteyttä. Metasploit-kone liitettiin tähän verkkoon valitsemalla koneen Settings valikosta Network, ja valitsemasta Attached To -kohdan ala-valikosta "Host-only Adapter", ja verkkokortti joka luotiin juuri.

Liitin myös viime kerralla luodun Kali-koneen tähän verkkoon samasta valikosta, mutta en vaihtanutkaan sen alkuperäisen verkkokortin verkkoa, vaan loin sille toisen verkkokortin, jonko asetin Host-only Adapteriksi. Tämä oli siis Adapter 2 tällä koneella; Adapter 1:n jätin NAT:n, jotta se saa sillä verkkoyhteyden tarvittaessa, jos huomaankin että minun pitää ladata koneelle verkosta jotakin. Mutta labratessa hyökkäystä pidän yhteyden Adapter 1:llä katkaistuna.

![image](https://user-images.githubusercontent.com/94109769/200134603-06d32d81-e8ea-4268-9876-749b3038cde3.png)


## B) Porttiskannausta

Haetaan ihan ensimmäisenä vähän tietoja tunkeutumiskohteestamme.

Kali Linuxin mukana tulee useimmiten Metasploit -ohjelma, jota hyödynnämme tässä. Komennolla ``msfdb run`` käynnistämme tietokantaan yhdistetyn ohjelman, jolla voimme kerätä helposti tietoa verkkoympäristöstä jossa olemme, ja jopa yksittäisistä koneista.

![image](https://user-images.githubusercontent.com/94109769/199807742-61d92b4f-81c5-43ac-9676-375c3093144e.png)

Luodaan ensin workspace tänne komennolla ``workspace -a metasploitable``, johon tallennamme tietoja. Komennolla voisi vastaavasti parametrin -a sijaan käyttää parametria -d, jolla workspacen voi poistaa, ja ilman parametreja komento ``workspace metasploitable`` suoraan tekee tästä uudesta workspacest aktiivisen.

Tämän jälkeen ajettiin komento ``db_nmap -sV -A <ip osoite/maski> -oA <tiedostonimi>``. Kuten Tero kertoi tunnilla, komento on käytännössä sama kuin suoraan komentoriviltä puhtaasti ajettu nmap, mutta se kerää sen kautta tietoja suoraan tänne metasploit-tietokantaan. -oA parametri tuossa ohjaa tallentamaan skannauksen tulokset ulkoiseen tiedostoon, jonka tiedostonimi tässä myös määritellään. Tiedostot tallennetaan kansioon, joka oli aktiivisena metasploit konsolin avaamisen yhteydessä. Tämä printtaa hirveän paljon kaikkea tietoa, mutta tietoa voi onneksi jälkeenpäin käsitellä hieman kohdennetummin. Esimerkiksi ``hosts`` komennolla, joka listaa kaikki verkossa olevat laitteet, jotka skannaus nappasi.

![image](https://user-images.githubusercontent.com/94109769/199809677-b8fdd692-f3a4-4d5f-b961-a0034194e940.png)

Kolmas rivi, jossa mac-osoitekkin on jäänyt tyhjäksi, on tämä Kali-kone josta skannaus suoritettiin, eli me itse. .1 osoite on tyypillisesti GW. En ole täysin varma mikä tuo .2 osoite on; mahdollisesti inet-verkkokortin osoite, josta nyt on siis virtuaalinen kaapeli pois irti? .4 osoite taas on Metasploitable 2 kone, ja skannaus osaakin kertoa että siellä pyörii jonkin sortin Linuxi, mikä käyttöliittymän versio on, ja suurinpiirteinen arvio koneen käyttötarkoituksesta.

Seuraava hyödyllinen komento on ``services``, joka listaa kaikki aukinaiset portit, jotka skannaus nappasi. Metasploit osaa myös kertoa valmiiksi monesta tunnetusta portista, mitä sillä todennäköisimmin on käytössä. Komennolle voi määritellä tietyn kohteen, jolta näyttää avonaiset portit-- käytetään sitä tässä tapauksessa tuon .4 koneen porttien tutkimiseen.

![image](https://user-images.githubusercontent.com/94109769/199813875-b277743d-821b-452c-b8be-57d388579687.png)

No täällähän oli hirveä määrä aukinaisia portteja. Tulkataan vähän tarkemmin muutamaa porttia tuolta...

``Port 23, telnet -- Linux telnetd``. Tämä on aukinainen portti telnet-yhteyksille, ja jokainen joka on vähänkään kiinnittänyt huomiota verkkoliikenteiden opinnoilla tietää, että telnet-yhteydet ovat järjettömän turvattomia, eikä niissä ole pahemmin salauksia. Teoriassa jos joku kirjaituisi palvelimelle sisään tällä yhteydellä, päästäisiin mahdollisesti kaappaamaan tunnustietoja salaamattomana.

``Port 3306/2534, mysql/postgresql``. Koneella pyörii selvästä SQL tietokantapalvelinohjelmistoa, jota jaetaan verkon kautta käyttöön.

``Port 6667, irc, UnrealIRCd``. Olen itse sen verran vanha, että tunnistin tämän termin heti. IRC oli ennen kaikkea discordeja ja muita ihmeellisiä instant messaging -ohjelmistoja oikein suosittu viestittelyprotokolla. Kone selvästi ajaa omaa IRC-palvelintaan tässä. En voi väittää että teininä olisin itse kauheasti tutustunut tämän tekniikan toimintaan, mutta näppituntumalta tulee vähän arvaus, että tätä kautta voisi löytyä jotain tunkeutumisessa hyväksikäytettävää.

Koneelta löytyy myös ftp-palvelinta, sekä verkkosivupalvelinta (Apache). Jos Apache ajaa pelkästään http:nä eikä https:nä sisällään olevia sivuja (johon tämä tuloste tuntuisi viittaavankin), voi niitä selavaa liikennettäkin tutkia jollain keinolla.

## C) Ensimmäinen korkkaus

Tehtävänä annettiin murtautua Metasploitable 2 -koneelle kahdesti. Tässä kohdassa käsittelen ensimmäistä yritystäni.

Kuten mainitsin, UnrealIRCd -palvelu josta on jätetty aukinainen portti kohdekoneelle pisti itselleni silmään, joten uteliaisuudesta lähdin tutkimaan sitä. Nopea googletus vahvisti epäilyni, että ohjelma on IRC-palvelin, ja jo pelkästään [ohjelman wikipediasivulta](https://en.wikipedia.org/wiki/UnrealIRCd) löytyi seuraava tiedonpalanen:

``The tarball of version 3.2.8.1, from November 2009 to June 12, 2010, contained a trojan that allowed people to execute commands with the privileges of the user running the daemon, regardless of any user restrictions. The problem was fixed - the current tarball download is not suspected to contain a trojan.``

IRC:tä nyt ei kauhean moni nykyään enään käytä muutenkaan, ja koska tämä kohdistuu vain tiettyyn vanhaan versioon, tällä tiedolla ei oikeassa elämässä ole varmaan kauhean paljon hyötyä, mutta harjoitusmaalin puitteissa tämä ehkä kävisi. Tämän tiedon johdosta ajoin nopeasti metasploitin konsolissa komennon ``search unrealircd`` tarkistaakseni, olisiko metasploitissa jo valmiiksi moduulia tämän haavoittuvuuden hyödyntämiseen.

![image](https://user-images.githubusercontent.com/94109769/200120346-7f67603d-acc1-4d22-a48f-5bbd2e5e1aec.png)

Sieltähän löytyi juuri se -- versionumerokin täsmää. Pelkästään porttiskannauksen tiedoista en ihan varmuudella tiennyt, ajoiko Metasploitable 2 juuri tuota oikeaa versiota. Otin kuitenkin tuon exploitin aktiiviseksi konsolissa (normaalisti tarvitsisi kirjoittaa koko polku, mutta haun jälkeen pystyin komennolla ``use 0`` suoraan valitsemaan listatun exploitin helposti). Tämän jälkeen asetin RHOSTS -parametrin Metasploitable 2:n IP-osoitteeksi -- tällä määrittelen siis kohdeosoitteen, jolle exploit ajetaan. Ja viimeinkin suoraan ``exploit`` komennolla ajettiin moduulin koodi.

![image](https://user-images.githubusercontent.com/94109769/200121277-c5ee8ea7-c092-4786-8cb4-a1218ef0ed53.png)

Ja ensimmäinen virhe tuli vastaan. Ilmeisesti yhteys saatiin, mutta ohjelmalle ei oltu määritelty, mitä tämän jälkeen tehdään. ``show payloads`` komennolla tässä samassa tilassa sain listattua tälle exploitille yhteensopivat payloadit, eli ohjelmaa jota ajetaan haavoittuvuuden lävitse.

![image](https://user-images.githubusercontent.com/94109769/200121419-7694003a-8f46-43fe-928b-e0d226faf73b.png)

Tästä päättelin, että jonkin näillä valitsemalla saisin (ehkä) käynnistettyä komentorivi-ikkunan ohjelman ajamisen jälkeen, jolla saisin ajettua komentoja kohdekoneella. Tietenkin innokkaana en tätä tarkistanut mistään lähteestä, vaan labrausmielessa valitsin tuosta Unix Command, Generic Command Execution -vaihtoehdon (``set payload payload/cmd/unix/generic``), ja ajoin ``exploit`` komennon uusiksi. Tästä tulikin virheviestinä ``MsF::OptionValidateError The following options failed to validate: CMD``. Tuo valitsemani vaihtoehto ei ollut mikään shelli ilmeisesti. En heti tässä vaiheessa tiennyt, mitä "reverse TCP" tarkoittaa, mutta edelleen labrausmielessä päätin kokeilla seuraavaksi vaihtoehtoa Unix Command Shell, Double Reverse TCP (telnet). Tässä vaiheessa ohjelman ajettaessa tuli herja LHOST -parametrin puuttumisesta. ``options`` komennolla selvisi, että payload vaatii omia asetuksiaan myös -- LHOST ja LPORT. LPORT eli portti, jota ohjelma kuuntelee, oli jo asetettu, mutta se tarvitsi vielä kuuntelevan osoitteen. Päättelin, että tähän varmaan tarvitaan oman koneen IP-osoite, joten syötin käyttämäni Kali VM:n paikallisen verkon osoitteen siihen. Ja tällä kertaa kun ajoin ohjelman...

![image](https://user-images.githubusercontent.com/94109769/200122181-c13f52db-95df-4e33-b03f-f69f506703d4.png)


Kuten kuvakaappauksesta näkyy, ohjelma ajoi itsensä lävitse, ja avasi session kali-koneen ja metasploitable -koneen välille. Ilmeisesti tästä tuli aika paljas shelli käyttöön-- viimeiset rivit tässä ovat pari minun ajamaani komentoa ja niiden vastaus-tulosteet, joilla yritin varmistaa että olin syöttämässä komentoja juuri kohdekoneelle. Eli whoami -komennolla katsoin mitä käyttäjää komensin, ja komennolla ``cat /etc/os-release`` yritin tarkistaa, mitä käyttäjärjestelmä oli pyörimässä -- kyseistä tiedostoa ei löytynyt, joten yritin seuraavaksi komentoa ``lsb-release -a``, jolla sain nähdä käyttöjärjestelmän tiedot. Selvästi olin siis päässyt koneeseen kiinni! Viimeisenä varmistuksena kokeilin vielä komentoa ``shutdown now`` nähdäkseni saako toisessa ikkunassa pyörivä metasploitable virtuaalikone oikeasti sammutuskehotteen. Ja kuinkas ollakkaan, metasploitable:n ikkunassa tuli heti varoitus järjestelmän sammumisesta, jonka jälkeen käyttöjärjestelmä sulki itsensä. Eli toimii!

## D) Toinen korkkaus

Vielä piti tämän jälkeen murtautua Metasploitable-koneelle jollain toisellakin tavalla. Itselläni oli hieman hukassa olevan tunnetta, joten lähdin tutkimaan muista lähteistä mahdollisia muita ratkaisuja ja lähestympistapoja. Kävin vilkaisemassa kylmästi opettajan linkkaamaa [metasploit exploitability guide](https://docs.rapid7.com/metasploit/metasploitable-2-exploitability-guide) artikkelissa, josta löytyikin monia aika suoraviivaisia hyökkäysvaihtoehtoja (mukaanlukien juuri kokeilemaani UnrealIRC -exploit!), mutta päätin että haluan ehkä kokeilla jotain näiden ulkopuolelta. Käytin pitkää aikaa palloillen haavoittuvuusten itsenäisesti löytämisessä, kunnes satuin törmäämään [artikkeliin](https://www.hackingtutorials.org/metasploit-tutorials/metasploitable-2-enumeration/), joka kertoi porttiskannauksen lisäksi kohdekoneen käyttäjien listaamisesta. Muistettuani törmänneeni ``search`` komennon käytön yhteydessä etsiessäni Metasploitable 2 -koneella käynnissä olevien ohjelmiin liittyviä moduuleita moduuliin, jota käytettiin ssh-kirjautumisen brute forcaamiseen, sain idean.

Noudattaen [hackingtutorials.org:n artikkelin](https://www.hackingtutorials.org/metasploit-tutorials/metasploitable-2-enumeration/) ohjeita, avasin metasploitin konsolin ulkopuolella rpcclient -yhteyden kohdekoneen samba -palvelimelle komennolla ``rpcclient –U “” [osoite]``, joka avaa yhteyden tyhjällä käyttäjänimellä. Session avettua sain komennolla ``enumdomusers`` haettua listan palvelimelta löyttyvistä käyttäjätileistä, jonka Samba oli kirjannut.

![image](https://user-images.githubusercontent.com/94109769/200131866-73888af1-02be-4499-a29c-ad99aaff5257.png)

Kopioin tämän koko tulosteen, vein sen omalle tekstitiedostolle metasploit -harjoituskansiooni, ja siivosin siitä pois kaikki ylimääräiset tekstit luodakseni siistin listan kohteen käyttäjistä.

Tämän jälkeen menin avaamaan metasploitissa auxiliary-moduulin ssh_login, komennolla ``auxiliary/scanner/ssh/ssh_login``. Täällä piti tehdä muutama asetus vielä:

![image](https://user-images.githubusercontent.com/94109769/200131955-18cc4782-d7ae-4196-8c32-78c6efdd5e19.png)

Tärkeimmät asetukset tässä ovat PASS_FILE ja USER_FILE. Tämä moduuli ei generoi automaattisesti miljoonia sanoja, vaan sille annetaan lähdetiedostot, joilta se hakee kokeiltavia käyttäjätunnuksia ja salasanoja. Kalissa tulee valmiiksi suuri määrä käyttäjä- ja salasanalistoja, joita voidaan tälläisissä hyökkäyksissä hyödyntää. Tässä tapauksessa käytin käyttäjätunnus-listana tekstitiedostoa, jonka muodostin haettuani kohdekoneelta käyttäjälistan, ja salasanalistana kali:sta löytynyttä suosituimpia unix:ssa käytettyjä salasanoja. Lisäksi määrittelin moduulia myös kokeilemaan salasanoina käyttäjien omia käyttäjänimiä. Huomautuksena että tässä kuvakaappauksessa VERBOSE asetus on vielä 'true', mutta koska tulosteesta tuli hirveän sotkuinen sen kanssa ensimmäisellä yrityksellä, otin sen pois päältä. Ajettuani ``run`` komennon käynnistääkseni hyökkäyksen, pitikin vain mennä tekemään muita töitä, koska tässä arvattavastikkin meni aika pitkään.

![image](https://user-images.githubusercontent.com/94109769/200148669-bce5a0cf-14c0-4e1a-b8f7-3657b50e3e2f.png)

Noin kolmen tunnin jälkeen päätin lopettaa tämän ajon, mutta sillä saatiin kuitenkin kuudelle käyttäjätunnukselle bruteforcettua salasanat. Tämä oli oikein hidas prosessi, joten ei tunkeutumisen kannalta kauhean tehokas -- ja oikeastaan todennäköisesti suorastaan mahdotonkin nykyaikaisilla turvamenetelmillä. Pitkät ja monimutkaiset salasanat tekisivät tehokkaamastakin salasananmurto-ohjelmasta vielä vaikeampaa voimakkaallamma raudallakin, ja nykyään kirjautumisyrityksiäkin voi tehdä vain rajallisen määrän tietyssä ajassa ennen kuin kirjautumisyrityksiä aletaan estämään. Kaikki nämä seikat huomioon ottaen tämä ei ole tehokas eikä millään lailla suositeltava hyökkäytymistapa, mutta tulipa sekin ainakin kokeiltua.

# Lähteet

Tero Karvinen, Tunkeutumistestaus ict4tn027 luento 31.10.2022

[Pentest-Standard.org: PTES Technical Guidelines](http://www.pentest-standard.org/index.php/PTES_Technical_Guidelines)

Jaswal, N. 2020. Mastering Metasploit

[https://en.wikipedia.org/wiki/UnrealIRCd](https://en.wikipedia.org/wiki/UnrealIRCd)

[https://www.hackingtutorials.org/metasploit-tutorials/metasploitable-2-enumeration/](https://www.hackingtutorials.org/metasploit-tutorials/metasploitable-
2-enumeration/)
