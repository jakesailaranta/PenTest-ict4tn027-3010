# OSINT ja Proxeja

Tällä viikolla käsiteltiin avoimia tiedustelulähteitä, ja man-in-the middle proxy testausta.

## A/B) ZAP

Aluksi piti asentaa ja testata OWASP ZAP -proxyohjelmisto. ZAP:ia käytetään web-applikaatioden liikenteen skannaamiseen PenTestaus mielessä.

OWASP ZAP:n [omilta sivuilta](https://www.zaproxy.org/download/) löytynyt linuxin asennuspaketti ei jostain syystä toiminut Kali VM:lläni, mutta nopea tutkiminen johdatti minut sivulle [https://www.kali.org/tools/zaproxy/](https://www.kali.org/tools/zaproxy/), josta selvisi nopeasti, että ohjelman saa ladattua Kaliin paketinhallinnalla pakettinimellä zaproxy. Eli syötin terminaaliin vain komennon ``sudo apt install zaproxy``.

![image](https://user-images.githubusercontent.com/94109769/203083778-a778574d-426d-4f5d-ab05-49dbc9d32772.png)

Yllä oleva viesti pomppasi itselleni vastaan ensimmäisen kerjan ZAPin avatessani. Itselläni oli [quick start guide](https://www.zaproxy.org/getting-started/) tälle ohjelmalle toisella monitorilla auki, ja sain sieltä varmistettua, että tämän tarkoitus on asettaa tiedostosijainti sessioiden ja lokien tallentamiselle. Nyt tässä vaiheessa en halunnut mitään alkaa tallentelemaan, joten valitsin vain 'No' vaihtoehdon.

Tässä vaiheessa piti tehtävänannon mukaan myös tarkistaa, saako liikennettä näkymään tämän proxy:n kautta, mutta itselläni tuli mieleen tämän kokeilun laillisuus. Pelkästään googlettamisella en saanut satavarmaa vastausta siihen, voinko käyttä ZAP-proxya julkisilla sivuilla laillisesti, joten päätin konfiguroida itselleni nopeasti Ubuntu VM:n, jossa käy Apache2 weppipalvelin ja aika paljas oletus-sivu joka on https-salattu.

ZAP:sta löytyi myös pikakomento, jolla voi avatta esi-konfiguroidun Firefox ikkunan joka käyttää ZAP:ia proxyna, joten käytin suosiolla sitä. Tätä kautta tuli vastaan myös aloitussivu, joka kertoi, että tämä selainsessio oli konfiguroitu myös hyppäämään sertifikaatti-varoitusten ohitse.

![image](https://user-images.githubusercontent.com/94109769/204086141-fa036b27-9d25-4a78-8218-427d0dc06a35.png)

Ja tätä proxitettua selainta käyttämällä hyppäsin ubuntu-palvelimen pyörittämälle sivulle, ja sieltä näkyikin liikennettä.

![image](https://user-images.githubusercontent.com/94109769/204089554-6efb24f0-5b1b-4f56-bccb-68ded77e267c.png)

Koska sivu oli Apachen oletussivu vain, ei täältä saanut valitettavasti kauhean paljon muuta irti kuin toimivuuden demoamista varten. Tämä GET-pyynnön vastauspaketti saatiin kyllä avattua myös, ja siellä se näkyi puhtaasti HTTP-tekstinä, vaikka sivu oli HTTPS-muodossa. Huomasin myös, kun avasin sivun turvallisuustietoja proxitetusta firefox-selaimsesta, että sivu oli merkitty salatuksi, ja siellä näkyi nyt palvelimella itse-allekirjoitetun ssl-sertifikaatin sijaan owasp:n sertifikaatti:

![image](https://user-images.githubusercontent.com/94109769/204089640-3ea2f0d8-3349-445d-9647-39e939d61979.png)

## C/D) MITMPROXY

mitmproxy oli Kali-VM:llä asennettuna jo valmiiksi, mutta en osannut käyttää sitä puhtaalta pöydältä. Tähän löytyi avuksi [Hussein Nasserin opetusvideo](https://www.youtube.com/watch?v=7BXsaU42yok); video oli kyllä tehty MAC-käyttöympäristöä silmälläpitäen, mutta sain sovellettua kuitenkin sen pohjalta.

Ajamalla siis komennon ``mitmproxy`` komentorivillä mitm proxypalvelin ja sen konsoli-ikkuna aukesi. Tällä nyt itsestään ei tee mitään, mutta oman työpaikkani ympäristöstä tunnen, että Firefoxiin voi määritellä proxypalvelimen (Settings > Network Settings > Configure Proxy Access to the Internet).

![image](https://user-images.githubusercontent.com/94109769/204090670-a3c4e288-2cfc-4248-b43d-dc3dc96c151c.png)

Nyt kun yritin yhdistää Ubuntu-palvelimen sivulle, tuli Firefoxilta varoitusviesti.

![image](https://user-images.githubusercontent.com/94109769/204090770-37810802-bcd5-4561-8100-f966dd6442ea.png)

Tämä tietenkin varoittaa ei-luotettavasta sertifikaatista. Näitäkin olisi varmasti tullut näkyviin ZAP:ia käyttäessä, jos sen kautta käynnistetty selainsivu ei olisi automaattisesti hypännyt näiden ohi. Hyppäsin nyt tämän ohitse manuaalisesta valitsemalla Advanced > Accept the Risk and Continue.

![image](https://user-images.githubusercontent.com/94109769/204090824-c29f6dc6-2f14-4c6d-a347-63d13c9f58d5.png)

Tätähän nyt ei varmaan pitänyt käydä. Vai pitikö? Katseltuani Husseinin videota vielä eteenpäin, samanlainen tapaus kävi hänelläkin, koska sertifikaatti onkin nyt mitmproxy:n tarjoama, eikä sivuston. Tämä sama asetelma oli kyllä tpaahtunut ZAP:n kanssa, mutta oletettavasti OWASP:n allekirjoittama sertifikaatti, joka silloin tuli käyttöön, ei todennäköisesti luetu itse-allekirjoitetuksi, joten silloin se kuitenkin meni lävitse. Hieman eteenpäin videota katsottua neuvottiin kirjoittamaan selaimen osoitekenttään ``mitm.it``. Tämä avaa mitm:n selain-käyttöliittymän. Tämä näyttää ehkä julkiselta sivunimeltä, mutta se onkin mitmproxy-palvelimen paikallisesti ylläpitämä, joten sain sen silti auki vaikka kali-koneellani ei tällä hetkellä ollut yhteyttä internettiin suuntaavaan verkkoon.

![image](https://user-images.githubusercontent.com/94109769/204091672-d43927c9-3b28-46e7-b2a3-06e205029e7e.png)

Latasin tästä nyt linuxia varten tämän sertifikaattitiedoston (nämäkin ilmeisesti oletettavasti saatavilla jo valmiiksi paikallispalvelimella) ja tästä samalla löytyvien ohjeiden avulla otin sen käyttöön siirtämällä ensin juuri ladatun tiedoston polkuun /usr/local/share/ca-certificates/, ja ajamalla tämän jälkeen komennon ``sudo update-ca-certificates``.

![image](https://user-images.githubusercontent.com/94109769/204091964-6fdd38b4-9242-46ff-b2ba-cca92085bf4b.png)

Tämän jälkeen yritin taas yhdistään ubuntu-koneen sivulle, mutta sama virheviesti ilmestyi edelleen. En löytänyt mitään muita ohjeita, jotka viittaisivat johonkin muuhun tapaan ratkaista tämä ongelma, joten tehtävä taisi tyssätä tähän.

## E) Proxy Vuoheen

Webgoatista löytyi HTTP Proxies -tehtävä, joka olikin varta vasten tehty ohjastamaan tälläisten proxyohjelmien käyttöön. Muutamalta ensimmäiseltä sivulta löyty johdantoja proxien toimintaan, jo proxien konfigurointiin firefoxille jos ei käytä suoraan ZAP:n esikonfiguroimaa selainikkunaa, mutta sivulla 5 olikin tärkeä huomautus siitä, että webgoatin kanssa kannattaa ainakin ZAP konfiguroida filtteröimään pois WEbGoatin sisäiset pyynnöt, jotta kaappaus ei pysähdy turhiin paketteihin.

Sivulla 6 annettiinkin tehtävä demonstrointia varten. Tarkoituksena oli asettaa kaappauspiste ZAPilla, jossa se ottaa seuraavan havaitun paketin käsittelyyn muokkausta varten ennen kuin se menee perille kohteellensa. Aikaisemman sivun ohjeiden mukaisten filtterien asetusten ansiosta ZAP ei tullut kaappaamaan mitään muuta pakettia kuin sen, joka tultiin sivun kautta manuaalisesti lähettämään, joten ei tarvinnut edes kahlata kaikkien pakettien läpi (WebGoatin sisäistä liikennettä vaikuttaisi liikkuvan aika paljon nimittäin).

Kaappauspiste asetettiin painikkeelta jossa on tallennusmerkin näköinen kuva:

![image](https://user-images.githubusercontent.com/94109769/204130956-69e5718a-7402-447a-992d-baf4a0f96462.png)

Tämän jälkeen kirjoitin tehtäväsivun syöttökenttään vain TEST ja painoin 'submit', jonka jälkeen paketti tulikin näkyviin ZAPissa. 

![image](https://user-images.githubusercontent.com/94109769/204130977-5a642473-5d04-458c-a9f5-fdf6fc377a83.png)

Ohjeiden mukaisesti muutin tämän GET -viestiksi vain muuttamalla POST -rivin GETiksi, lisäsin otsikkotietoihin rivin ``x-request-intercepted:true`` ja vaihdoin leipätekstin:

![image](https://user-images.githubusercontent.com/94109769/204131141-6f697205-c82c-4fb1-bac7-84027c18dfa2.png)

Tämän jälkeen painoin 'play' merkin omaavaa nappia ZAPissa, joka päästi viestin jatkamaan muokatussa muodossa matkaansa.

![image](https://user-images.githubusercontent.com/94109769/204131178-1a722be1-7928-4cb0-8a30-2a35f29fb24f.png)

Tämä oli tosin sen verran suoraviivaista, että halusin vielä kokeilla soveltaa tätä jossain webgoatin tehtävässä, jossa ei erikseen neuvota käyttämään ZAPia. A2 -osan Authentication Bypasses tehtävässä, jota piti aikaisemmalla viikollakin tehdä, en ikinä saanut tehtävää ratkaistua. Päätin nyt kokeilla sitä uudelleen ZAPin voimin. Asetin taas kaappauspisteen sivulle saavuttua, ja sen jälkeen syötin satunnaista tekstiä syötekenttään joka esitti salasana-palautuksen turvallisuuskysymyksiin vastaamista.

![image](https://user-images.githubusercontent.com/94109769/204131508-0388b808-15ed-42fb-bc2f-0f2b138a3315.png)

Paketti lähetettiin matkaan, mutta se tuli auki ZAPilla ensin tälläisessä muodossa. Ohjeissa puhuttiin vanhasta heikkoudesta PayPalin kanssa (joka sittemmin korjattu), jossa joku oli jo proxylla samanlaisessa salasananpalautuksessa poistanut kysymysten parametrit ja päässyt pelkästään sillä läpi. Tätä tietoa käyttäen poistin paketin sisällöstä kuvassa värjätyn osion ja lähetin paketin takaisin matkaan, mutta tällä tehtävä ei kuitenkaan ratkennut.

Pienen pähkäilyn jälkeen katselinkin, että teksti jota omasta paketista oli tullut ei ollut kuitenkaan samannäköinen mitä esitetyssä esimerkissä ollut, joten varmaankin takana oleva tarkistusohjelmakin toimii eri lailla. Tällä ymmärrykselläkään en päässyt pelkästään kovin pitkälle, ja lopulta jouduin katsomaan WebGoatin omia vihjeitä, jotka ehdottivat muokkaamaan parametreja niiden poistamisen sijaan. En voi väittää että olisin tälläkään ymmärtänyt mitä minun olisi käytännössä tarkoitus saada aikaan, mutta kokeilin muokkaa viestissä parametrien nimiä (secQUestion0 -> secQuestion2, secQuestion 1 -> secQuestion3), ja yllättäen tehtävä menikin tällä lävitse.

![image](https://user-images.githubusercontent.com/94109769/204132018-5112e079-985d-4962-a861-b720260030b7.png)

Ainoa mitä tähän keksin tempun toimivuuden syyksi hyvin pienellä ohjelmointitaidollani, että takana pyörivällä ohjelmalla on kysymysten vastauksia tarkistavassa else/if lausekkeessa jonkinnäköinen virhesilmukka, joka johtaa kahden kokonaan uuden muuttujan saamisen antamaan hyväksyttävän boolean-arvon. Tai jotain vastaavaa. En ole ohjelmoija. ._.

## Lähteet

[Tehtävänanto](https://terokarvinen.com/2022/tunkeutumistestaus-ict4tn027-3010-syksylla-2022/#h5-kautta-kiven-ja-kannon)
[https://www.kali.org/tools/zaproxy/](https://www.kali.org/tools/zaproxy/)
[Hussein Nasser - Capture, Analyze and Debug HTTPS traffic with MITMProxy](https://www.youtube.com/watch?v=7BXsaU42yok)
